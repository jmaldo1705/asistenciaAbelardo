<div class="container">
  <!-- Encabezado con estadÃ­sticas -->
  <div class="header">
    <!-- Banner del evento con imÃ¡genes -->
    <div class="event-banner">
      <div class="banner-images">
        <img src="assets/abelardo.png" alt="Abelardo de la Espriella" class="leader-photo">
        <div class="event-title-section">
          <h1>
            <div class="defensores-logo-banner">
              <img src="assets/defensores.png" alt="Defensores de la Patria" class="defensores-image-banner">
            </div>
          </h1>
          <p class="event-subtitle">Â¡COLOMBIA ESCUCHARÃ LO DURO QUE RUGEN LOS TIGRES!</p>
          <p class="event-leader">Abelardo de la Espriella - Nuestro MÃ¡ximo LÃ­der</p>
        </div>
        <img src="assets/tigre.png" alt="Tigre" class="tiger-image">
      </div>
    </div>

    <!-- BotÃ³n de cerrar sesiÃ³n -->
    <div class="logout-section">
      <button class="btn-logout" (click)="logout()" title="Cerrar sesiÃ³n">
        ğŸšª Cerrar SesiÃ³n
      </button>
    </div>

    <div class="stats-cards">
      <div class="stat-card total">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-info">
          <div class="stat-number">{{ estadisticas.total }}</div>
          <div class="stat-label">Total Defensores</div>
        </div>
      </div>
    </div>
  </div>

  <!-- BotÃ³n para agregar nuevo defensor -->
  <div class="action-bar">
    <button class="btn-nuevo" (click)="abrirModalNuevo()">
      <span class="btn-icon-main">+</span> Agregar Defensor
    </button>
    <button class="btn-eventos" (click)="irAEventos()">
      <span class="btn-icon-main">ğŸ“…</span> Gestionar Eventos
    </button>
    <button class="btn-exportar" (click)="exportarAExcel()">
      <span class="btn-icon-main">â†“</span> Exportar a Excel
    </button>
    <button class="btn-mapa" (click)="irAMapaCalor()">
      <span class="btn-icon-main">ğŸ—º</span> Ver Mapa de Calor
    </button>
  </div>

  <!-- Filtros -->
  <div class="filters">
    <div class="filter-group">
      <label>ğŸ” Buscar:</label>
      <input type="text" [(ngModel)]="filtroMunicipio" (ngModelChange)="resetearPaginacion()"
        placeholder="Buscar por municipio, sector, nombre, celular, email u observaciones..." class="filter-input">
    </div>
  </div>

  <!-- Tabla de defensores -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Municipio</th>
          <th>Sector</th>
          <th>Defensor</th>
          <th>Celular</th>
          <th>Email</th>
          <th>Llamadas</th>
          <th>Fecha Llamada</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let coordinador of coordinadoresPaginados" [class.confirmado-row]="coordinador.confirmado">
          <td><strong>{{ coordinador.municipio || '-' }}</strong></td>
          <td><strong>{{ coordinador.sector || '-' }}</strong></td>
          <td>{{ coordinador.nombreCompleto }}</td>
          <td>
            <a href="tel:{{ coordinador.celular }}" class="phone-link">
              {{ coordinador.celular }}
            </a>
          </td>
          <td class="email-cell">
            <a *ngIf="coordinador.email" [href]="'mailto:' + coordinador.email" class="email-link">
              {{ coordinador.email }}
            </a>
            <span *ngIf="!coordinador.email">-</span>
          </td>
          <td>{{ coordinador.llamadas ? coordinador.llamadas.length : 0 }}</td>
          <td>{{ formatearFecha(coordinador.fechaLlamada) }}</td>
          <td class="actions-cell">
            <div class="actions-buttons-group">
              <button class="btn-action btn-action-call" (click)="abrirModalRegistrarLlamada(coordinador)" title="Registrar llamada">
                <span class="btn-icon">â˜</span>
              </button>
              <button class="btn-action btn-action-view" (click)="verHistorialLlamadas(coordinador)" title="Ver historial">
                <span class="btn-icon">ğŸ“‹</span>
              </button>
              <button class="btn-action btn-action-edit" (click)="abrirModalEditar(coordinador)" title="Editar">
                <span class="btn-icon">âœ</span>
              </button>
              <button class="btn-action btn-action-delete" (click)="eliminarCoordinador(coordinador)" title="Eliminar">
                <span class="btn-icon">âœ•</span>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="coordinadoresFiltrados.length === 0">
          <td colspan="8" class="empty-message">
            No se encontraron defensores
          </td>
        </tr>
  </tbody>
  </table>
</div>

<!-- Controles de paginaciÃ³n -->
<div class="pagination-container" *ngIf="coordinadoresFiltrados.length > 0">
  <div class="pagination-info">
    <span>Mostrando {{ (paginaActual - 1) * itemsPorPagina + 1 }} -
      {{ Math.min(paginaActual * itemsPorPagina, coordinadoresFiltrados.length) }}
      de {{ coordinadoresFiltrados.length }} defensores</span>

    <div class="items-per-page">
      <label>Mostrar:</label>
      <select (change)="cambiarItemsPorPagina($event)" [value]="itemsPorPagina" class="page-size-select">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span>por pÃ¡gina</span>
    </div>
  </div>

  <div class="pagination-controls" *ngIf="totalPaginas > 1">
    <button class="page-btn" (click)="cambiarPagina(1)" [disabled]="paginaActual === 1" title="Primera pÃ¡gina">
      âŸª
    </button>
    <button class="page-btn" (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1"
      title="PÃ¡gina anterior">
      â€¹
    </button>

    <button *ngFor="let pagina of paginasArray" class="page-btn" [class.active]="pagina === paginaActual"
      (click)="cambiarPagina(pagina)">
      {{ pagina }}
    </button>

    <button class="page-btn" (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas"
      title="PÃ¡gina siguiente">
      â€º
    </button>
    <button class="page-btn" (click)="cambiarPagina(totalPaginas)" [disabled]="paginaActual === totalPaginas"
      title="Ãšltima pÃ¡gina">
      âŸ«
    </button>
  </div>
</div>
</div>

<!-- Modal para nuevo defensor -->
<div class="modal-overlay" *ngIf="mostrarModalNuevo" (click)="cerrarModalNuevo()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>â• Nuevo Defensor</h2>
    </div>
    <div class="modal-body">
      <div class="form-group autocomplete-container">
        <label>Municipio ğŸŒ <span class="required">*</span></label>
        <input type="text" [(ngModel)]="nuevoCoordinador.municipio" (input)="buscarMunicipios($event)" class="form-control"
          [class.invalid]="!municipioSeleccionadoDeLista && nuevoCoordinador.municipio.trim()"
          placeholder="Escribe para buscar municipio o ciudad (obligatorio - seleccione de la lista)..." autocomplete="off">
        <div class="autocomplete-suggestions" *ngIf="mostrandoSugerenciasMunicipio">
          <div class="suggestion-item" *ngFor="let sugerencia of municipioSugerencias"
            (click)="seleccionarMunicipio(sugerencia)">
            <span class="suggestion-icon">ğŸ“</span>
            <span class="suggestion-text">{{ sugerencia.description }}</span>
          </div>
        </div>
        <small class="form-hint" *ngIf="!municipioSeleccionadoDeLista && nuevoCoordinador.municipio.trim()">
          âš ï¸ Debe seleccionar el municipio de la lista de sugerencias
        </small>
      </div>

      <div class="form-group autocomplete-container">
        <label>Sector ğŸ˜ï¸</label>
        <input type="text" [(ngModel)]="nuevoCoordinador.sector" (input)="buscarSectores($event)"
          class="form-control" 
          [disabled]="!nuevoCoordinador.municipio || !nuevoCoordinador.municipio.trim()"
          placeholder="{{ nuevoCoordinador.municipio ? 'Escribe para buscar sector, vereda o corregimiento (opcional)...' : 'Primero seleccione un municipio' }}" 
          autocomplete="off">
        <div class="autocomplete-suggestions" *ngIf="mostrandoSugerenciasSector">
          <div class="suggestion-item" *ngFor="let sugerencia of sectorSugerencias"
            (click)="seleccionarSector(sugerencia)">
            <span class="suggestion-icon">ğŸ“</span>
            <span class="suggestion-text">{{ sugerencia.description }}</span>
          </div>
        </div>
        <small class="form-hint" *ngIf="!nuevoCoordinador.municipio || !nuevoCoordinador.municipio.trim()">
          âš ï¸ Debe seleccionar un municipio primero para buscar sectores
        </small>
      </div>

      <div class="form-group">
        <label>Nombre Completo *</label>
        <input type="text" [(ngModel)]="nuevoCoordinador.nombreCompleto" class="form-control"
          placeholder="Nombre completo del defensor">
      </div>

      <div class="form-group">
        <label>Celular *</label>
        <input type="tel" [(ngModel)]="nuevoCoordinador.celular" class="form-control" placeholder="NÃºmero de celular">
      </div>

      <div class="form-group">
        <label>Correo ElectrÃ³nico</label>
        <input type="email" [(ngModel)]="nuevoCoordinador.email" class="form-control"
          placeholder="correo@ejemplo.com (opcional)">
      </div>

      <p class="form-note">* Campos obligatorios</p>
      <p class="form-note">ğŸŒ Los campos de municipio y sector usan Google Maps para autocompletado</p>
      <p class="form-note">ğŸ’¡ Puedes dejar municipio o sector en blanco, pero al menos uno debe estar completo</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalNuevo()">Cancelar</button>
      <button class="btn btn-primary" (click)="guardarNuevoCoordinador()">ğŸ’¾ Guardar</button>
    </div>
  </div>
</div>

<!-- Modal de confirmaciÃ³n para eliminar defensor -->
<div class="modal-overlay" *ngIf="mostrarModalEliminar" (click)="cerrarModalEliminar()">
  <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
    <div class="modal-header modal-header-danger">
      <h2>âš ï¸ Confirmar EliminaciÃ³n</h2>
      <button class="close-btn" (click)="cerrarModalEliminar()">âœ•</button>
    </div>
    <div class="modal-body" *ngIf="coordinadorAEliminar">
      <div class="confirm-icon">
        <span class="icon-warning">ğŸ—‘ï¸</span>
      </div>
      <p class="confirm-message">
        Â¿EstÃ¡ seguro de que desea eliminar a este defensor?
      </p>
      <div class="confirm-details">
        <p><strong>Municipio:</strong> {{ coordinadorAEliminar.municipio }}</p>
        <p><strong>Defensor:</strong> {{ coordinadorAEliminar.nombreCompleto }}</p>
        <p><strong>Celular:</strong> {{ coordinadorAEliminar.celular }}</p>
        <p *ngIf="coordinadorAEliminar.confirmado" class="warning-text">
          âš ï¸ Este defensor tiene {{ coordinadorAEliminar.numeroInvitados }} invitados confirmados
        </p>
      </div>
      <p class="confirm-warning">
        <strong>Esta acciÃ³n no se puede deshacer.</strong>
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalEliminar()">Cancelar</button>
      <button class="btn btn-danger" (click)="confirmarEliminar()">
        ğŸ—‘ï¸ SÃ­, Eliminar
      </button>
    </div>
  </div>
</div>

<!-- Modal para editar defensor -->
<div class="modal-overlay" *ngIf="mostrarModalEditar" (click)="cerrarModalEditar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>âœï¸ Editar Defensor</h2>
      <button class="close-btn" (click)="cerrarModalEditar()">âœ•</button>
    </div>
    <div class="modal-body" *ngIf="coordinadorEditando">
      <div class="form-group autocomplete-container">
        <label>Municipio ğŸŒ <span class="required">*</span></label>
        <input type="text" [(ngModel)]="coordinadorEditando.municipio" (input)="buscarMunicipiosEditar($event)"
          class="form-control" 
          [class.invalid]="!municipioSeleccionadoDeListaEditar && coordinadorEditando.municipio.trim()"
          placeholder="Escribe para buscar municipio o ciudad (obligatorio - seleccione de la lista)..." autocomplete="off">
        <div class="autocomplete-suggestions" *ngIf="mostrandoSugerenciasMunicipioEditar">
          <div class="suggestion-item" *ngFor="let sugerencia of municipioSugerenciasEditar"
            (click)="seleccionarMunicipioEditar(sugerencia)">
            <span class="suggestion-icon">ğŸ“</span>
            <span class="suggestion-text">{{ sugerencia.description }}</span>
          </div>
        </div>
        <small class="form-hint" *ngIf="!municipioSeleccionadoDeListaEditar && coordinadorEditando.municipio.trim()">
          âš ï¸ Debe seleccionar el municipio de la lista de sugerencias
        </small>
      </div>

      <div class="form-group autocomplete-container">
        <label>Sector ğŸ˜ï¸</label>
        <input type="text" [(ngModel)]="coordinadorEditando.sector" (input)="buscarSectoresEditar($event)"
          class="form-control" 
          [disabled]="!coordinadorEditando.municipio || !coordinadorEditando.municipio.trim()"
          placeholder="{{ coordinadorEditando.municipio ? 'Escribe para buscar sector, vereda o corregimiento (opcional)...' : 'Primero seleccione un municipio' }}" 
          autocomplete="off">
        <div class="autocomplete-suggestions" *ngIf="mostrandoSugerenciasSectorEditar">
          <div class="suggestion-item" *ngFor="let sugerencia of sectorSugerenciasEditar"
            (click)="seleccionarSectorEditar(sugerencia)">
            <span class="suggestion-icon">ğŸ“</span>
            <span class="suggestion-text">{{ sugerencia.description }}</span>
          </div>
        </div>
        <small class="form-hint" *ngIf="!coordinadorEditando.municipio || !coordinadorEditando.municipio.trim()">
          âš ï¸ Debe seleccionar un municipio primero para buscar sectores
        </small>
      </div>

      <div class="form-group">
        <label>Nombre Completo *</label>
        <input type="text" [(ngModel)]="coordinadorEditando.nombreCompleto" class="form-control"
          placeholder="Nombre completo del defensor">
      </div>

      <div class="form-group">
        <label>Celular *</label>
        <input type="tel" [(ngModel)]="coordinadorEditando.celular" class="form-control"
          placeholder="NÃºmero de celular">
      </div>

      <div class="form-group">
        <label>Correo ElectrÃ³nico</label>
        <input type="email" [(ngModel)]="coordinadorEditando.email" class="form-control"
          placeholder="correo@ejemplo.com (opcional)">
      </div>

      <p class="form-note">* Campos obligatorios</p>
      <p class="form-note">ğŸ’¡ Las llamadas y observaciones se gestionan desde el historial de llamadas (botÃ³n ğŸ‘ï¸)</p>
      <p class="form-note">ğŸŒ Los campos de municipio y sector usan Google Maps para autocompletado</p>
      <p class="form-note">ğŸ’¡ Puedes dejar municipio o sector en blanco, pero al menos uno debe estar completo</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalEditar()">Cancelar</button>
      <button class="btn btn-primary" (click)="guardarEdicion()">ğŸ’¾ Guardar Cambios</button>
    </div>
  </div>
</div>

<!-- Modal para ver historial de llamadas -->
<div class="modal-overlay" *ngIf="mostrarModalHistorial" (click)="cerrarModalHistorial()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ğŸ“ Historial de Llamadas</h2>
      <button class="close-btn" (click)="cerrarModalHistorial()">âœ•</button>
    </div>
    <div class="modal-body" *ngIf="coordinadorSeleccionadoHistorial">
      <div class="modal-info">
        <p><strong>Municipio:</strong> {{ coordinadorSeleccionadoHistorial.municipio || '-' }}</p>
        <p><strong>Sector:</strong> {{ coordinadorSeleccionadoHistorial.sector || '-' }}</p>
        <p><strong>Defensor:</strong> {{ coordinadorSeleccionadoHistorial.nombreCompleto }}</p>
        <p><strong>Celular:</strong> {{ coordinadorSeleccionadoHistorial.celular }}</p>
        <p><strong>Total de llamadas:</strong> {{ historialLlamadas.length }}</p>
      </div>

      <hr>

      <h3>Historial</h3>
      <div *ngIf="historialLlamadas.length === 0" class="empty-message">
        No hay llamadas registradas para este defensor.
      </div>

      <div class="llamadas-list" *ngIf="historialLlamadas.length > 0">
        <div class="llamada-item" *ngFor="let llamada of historialLlamadas">
          <div class="llamada-header">
            <span class="llamada-fecha">ğŸ“… {{ formatearFecha(llamada.fecha) }}</span>
            <button class="btn-delete-llamada" (click)="eliminarLlamada(llamada.id!)" title="Eliminar llamada">
              ğŸ—‘ï¸
            </button>
          </div>
          <div class="llamada-evento" *ngIf="llamada.evento">
            <strong>ğŸ“… Evento:</strong> {{ llamada.evento.nombre }} - {{ formatearFecha(llamada.evento.fecha) }}
          </div>
          <div class="llamada-observaciones">
            {{ llamada.observaciones || 'Sin observaciones' }}
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalHistorial()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal para registrar llamada rÃ¡pida -->
<div class="modal-overlay" *ngIf="mostrarModalRegistrarLlamada" (click)="cerrarModalRegistrarLlamada()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ğŸ“ Registrar Llamada</h2>
      <button class="close-btn" (click)="cerrarModalRegistrarLlamada()">âœ•</button>
    </div>
    <div class="modal-body" *ngIf="coordinadorSeleccionadoLlamada">
      <div class="modal-info">
        <p><strong>Municipio:</strong> {{ coordinadorSeleccionadoLlamada.municipio || '-' }}</p>
        <p><strong>Sector:</strong> {{ coordinadorSeleccionadoLlamada.sector || '-' }}</p>
        <p><strong>Defensor:</strong> {{ coordinadorSeleccionadoLlamada.nombreCompleto }}</p>
        <p><strong>Celular:</strong> {{ coordinadorSeleccionadoLlamada.celular }}</p>
      </div>

      <div class="form-group">
        <label>Evento *</label>
        <select [(ngModel)]="eventoSeleccionadoLlamada" class="form-control" required>
          <option [value]="null">Seleccione un evento</option>
          <option *ngFor="let evento of eventos" [value]="evento.id">
            {{ evento.nombre }} - {{ formatearFecha(evento.fecha) }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Observaciones</label>
        <textarea [(ngModel)]="observacionesLlamadaRapida" rows="4" class="form-control"
          placeholder="Observaciones de la llamada..."></textarea>
      </div>

      <p class="form-note">* El evento es obligatorio para registrar la llamada</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalRegistrarLlamada()">Cancelar</button>
      <button class="btn btn-primary" (click)="registrarLlamadaRapida()" [disabled]="!eventoSeleccionadoLlamada">
        ğŸ’¾ Registrar Llamada
      </button>
    </div>
  </div>
</div>