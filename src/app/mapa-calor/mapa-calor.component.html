<div class="container">
  <!-- Header -->
  <div class="mapa-header-section">
    <div class="header-top">
      <h1>ğŸ—ºï¸ Mapa de Calor de Defensores</h1>
      <button class="btn-volver" (click)="volver()">
        â† Volver a Listado
      </button>
    </div>

    <!-- EstadÃ­sticas -->
    <div class="stats-cards-mapa">
      <div class="stat-card-mapa">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-info">
          <div class="stat-number">{{ totalDefensores }}</div>
          <div class="stat-label">Total Defensores</div>
        </div>
      </div>
      <div class="stat-card-mapa">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-info">
          <div class="stat-number">{{ ubicacionesUnicas.size }}</div>
          <div class="stat-label">Ubicaciones Ãšnicas</div>
        </div>
      </div>
      <div class="stat-card-mapa info-card">
        <div class="stat-icon">â„¹ï¸</div>
        <div class="stat-info">
          <div class="stat-label-small">El mapa agrupa defensores por municipio</div>
        </div>
      </div>
    </div>

    <!-- Controles del mapa -->
    <div class="controles-mapa">
      <div class="filtro-evento">
        <label for="filtro-evento-select">Filtrar por evento:</label>
        <select
          id="filtro-evento-select"
          [(ngModel)]="eventoSeleccionadoId"
          (ngModelChange)="filtrarPorEvento()"
          class="select-evento">
          <option [ngValue]="null">-- Todos los eventos --</option>
          <option *ngFor="let evento of eventos" [ngValue]="evento.id">
            {{ evento.nombre }}
          </option>
        </select>
      </div>

      <!-- Filtro por ubicaciÃ³n (Municipio o Sector) -->
      <div class="filtro-ubicacion">
        <label>Filtrar por:</label>
        <div class="filtro-tipo-btns">
          <button 
            class="btn-tipo-filtro" 
            [class.activo]="tipoFiltroUbicacion === 'municipio'"
            (click)="tipoFiltroUbicacion = 'municipio'; cambiarTipoFiltroUbicacion()">
            ğŸ™ï¸ Municipio
          </button>
          <button 
            class="btn-tipo-filtro" 
            [class.activo]="tipoFiltroUbicacion === 'sector'"
            (click)="tipoFiltroUbicacion = 'sector'; cambiarTipoFiltroUbicacion()">
            ğŸ“ Sector
          </button>
        </div>
      </div>

      <!-- Select de municipio -->
      <div class="filtro-select" *ngIf="tipoFiltroUbicacion === 'municipio'">
        <label for="filtro-municipio-select">Municipio:</label>
        <select
          id="filtro-municipio-select"
          [(ngModel)]="municipioSeleccionado"
          (ngModelChange)="filtrarPorMunicipio()"
          class="select-evento">
          <option [ngValue]="null">-- Todos los municipios --</option>
          <option *ngFor="let mun of municipiosUnicos" [ngValue]="mun">
            {{ mun }}
          </option>
        </select>
      </div>

      <!-- Select de sector -->
      <div class="filtro-select" *ngIf="tipoFiltroUbicacion === 'sector'">
        <label for="filtro-sector-select">Sector:</label>
        <select
          id="filtro-sector-select"
          [(ngModel)]="sectorSeleccionado"
          (ngModelChange)="filtrarPorSector()"
          class="select-evento">
          <option [ngValue]="null">-- Todos los sectores --</option>
          <option *ngFor="let sec of sectoresUnicos" [ngValue]="sec.sector + '|' + sec.municipio">
            {{ sec.sector }} ({{ sec.municipio }})
          </option>
        </select>
        <small class="filtro-hint" *ngIf="sectoresUnicos.length === 0">
          âš ï¸ Solo se muestran sectores con coordenadas de Google Maps
        </small>
      </div>

      <button class="btn-control" (click)="toggleHeatmap()" title="Mostrar/Ocultar cÃ­rculos de calor">
        <span class="btn-icon-control">{{ mostrarCirculos ? 'ğŸ‘ï¸' : 'ğŸ”¥' }}</span>
        {{ mostrarCirculos ? 'Ocultar' : 'Mostrar' }} CÃ­rculos
      </button>
    </div>
  </div>

  <!-- Contenedor principal del mapa y leyenda -->
  <div class="mapa-content-wrapper">
    <!-- Indicador de carga -->
    <div *ngIf="cargando" class="cargando-mapa">
      <div class="spinner"></div>
      <p>Geocodificando ubicaciones y generando mapa de calor...</p>
      <p class="cargando-hint">Esto puede tomar unos momentos</p>
    </div>

    <!-- Mapa con marco -->
    <div class="mapa-wrapper">
      <div id="mapa-calor" [class.cargando]="cargando"></div>
    </div>

    <!-- Leyenda -->
    <div class="leyenda" *ngIf="!cargando">
      <h3>ğŸ“Š Leyenda</h3>
      <div class="leyenda-content">
        <div class="leyenda-item">
          <div class="leyenda-color" style="background: #3b82f6;"></div>
          <span>Pocos defensores (Azul)</span>
        </div>
        <div class="leyenda-item">
          <div class="leyenda-color" style="background: #f59e0b;"></div>
          <span>Defensores moderados (Naranja)</span>
        </div>
        <div class="leyenda-item">
          <div class="leyenda-color" style="background: #ef4444;"></div>
          <span>Muchos defensores (Rojo)</span>
        </div>
      </div>
      <p class="leyenda-note">
        ğŸ’¡ Haz clic en los marcadores para ver detalles. Los cÃ­rculos muestran la densidad de defensores.
      </p>
    </div>
  </div>
</div>
